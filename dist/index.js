"use strict";var oe=Object.create;var q=Object.defineProperty;var ne=Object.getOwnPropertyDescriptor;var ae=Object.getOwnPropertyNames;var ue=Object.getPrototypeOf,ie=Object.prototype.hasOwnProperty;var de=(t,e)=>{for(var s in e)q(t,s,{get:e[s],enumerable:!0})},ce=(t,e,s,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of ae(e))!ie.call(t,o)&&o!==s&&q(t,o,{get:()=>e[o],enumerable:!(n=ne(e,o))||n.enumerable});return t};var j=(t,e,s)=>(s=t!=null?oe(ue(t)):{},ce(e||!t||!t.__esModule?q(s,"default",{value:t,enumerable:!0}):s,t));var te=j(require("cors")),Oe=require("dotenv/config"),J=j(require("express"));var K=j(require("jsonwebtoken")),V=process.env.JWT_SECRET,le=(t,e,s)=>{let n=t.headers.authorization;if(!n){e.status(401).json({message:"Acesso negado: Cabe\xE7alho de autoriza\xE7\xE3o n\xE3o encontrado."});return}if(!n.startsWith("Bearer ")){e.status(401).json({message:"Formato do token inv\xE1lido. Certifique-se de que o token come\xE7a com 'Bearer '."});return}let o=n.split(" ")[1];if(!o){e.status(401).json({message:"Token n\xE3o fornecido. Certifique-se de que o token est\xE1 presente."});return}try{if(!V)throw new Error("JWT_SECRET n\xE3o est\xE1 definido no ambiente.");let i=K.default.verify(o,V);return t.userId=i.id,s()}catch{e.status(401).json({message:"Token inv\xE1lido ou expirado."});return}},O=le;var r=require("drizzle-orm"),Q=j(require("express"));var ve=require("dotenv/config"),$=require("drizzle-orm/node-postgres"),G=require("pg");var B={};de(B,{alertTable:()=>l,sensorDataTable:()=>h,sensorTable:()=>a,userTable:()=>y});var u=require("drizzle-orm/pg-core"),y=(0,u.pgTable)("user",{userId:(0,u.serial)("user_id").primaryKey(),name:(0,u.varchar)("name",{length:255}),email:(0,u.varchar)("email",{length:255}).unique(),password:(0,u.varchar)("password",{length:255}),creationDate:(0,u.timestamp)("creation_date").defaultNow()}),a=(0,u.pgTable)("sensor",{sensorId:(0,u.serial)("sensor_id").primaryKey(),userId:(0,u.integer)("user_id").references(()=>y.userId),sensorName:(0,u.varchar)("sensor_name",{length:255}),location:(0,u.varchar)("location",{length:255}),installationDate:(0,u.timestamp)("installation_date"),webhookToken:(0,u.varchar)("weebhook_token",{length:255}).unique()},t=>({fkUser:(0,u.foreignKey)({columns:[t.userId],foreignColumns:[y.userId],name:"fk_user"})})),h=(0,u.pgTable)("sensor_data",{sensorDataId:(0,u.serial)("sensor_data_id").primaryKey(),sensorId:(0,u.integer)("sensor_id").references(()=>a.sensorId),soilHumidity:(0,u.real)("soil_humidity"),levelHumidity:(0,u.varchar)("level_humidity",{length:50}),temperature:(0,u.real)("temperature"),levelTemperature:(0,u.varchar)("level_temperature",{length:50}),condutivity:(0,u.real)("condutivity"),levelCondutivity:(0,u.varchar)("level_condutivity",{length:50}),ph:(0,u.real)("ph"),levelPh:(0,u.varchar)("level_ph",{length:50}),nitrogen:(0,u.real)("nitrogen"),levelNitrogen:(0,u.varchar)("level_nitrogen",{length:50}),phosphorus:(0,u.real)("phosphorus"),levelPhosphorus:(0,u.varchar)("level_phosphorus",{length:50}),potassium:(0,u.real)(" potassium"),levelPotassium:(0,u.varchar)("level_potassium",{length:50}),dateTime:(0,u.timestamp)("date_time").defaultNow()},t=>({fkSensor:(0,u.foreignKey)({columns:[t.sensorId],foreignColumns:[a.sensorId],name:"fk_sensor"})})),l=(0,u.pgTable)("alert",{alertId:(0,u.serial)("alert_id").primaryKey(),sensorId:(0,u.integer)("sensor_id").references(()=>a.sensorId),message:(0,u.text)("message"),level:(0,u.varchar)("level",{length:50}),timestamp:(0,u.timestamp)("timestamp").defaultNow()},t=>({fkSensorAlert:(0,u.foreignKey)({columns:[t.sensorId],foreignColumns:[a.sensorId],name:"fk_sensor_alert"})}));if(!process.env.DB_HOST||!process.env.DB_USER||!process.env.DB_PASSWORD||!process.env.DB_NAME)throw new Error("Missing database environment variables");var me=new G.Pool({host:process.env.DB_HOST||"localhost",port:parseInt(process.env.DB_PORT||"5432"),user:process.env.DB_USER||"username",password:process.env.DB_PASSWORD||"password",database:process.env.DB_NAME||"dbname",ssl:process.env.NODE_ENV==="production"}),d=(0,$.drizzle)(me,{schema:B});var m=Q.default.Router(),p="Erro no Servidor, tente novamente",pe="N\xE3o encontrado",S="Campos obrigat\xF3rios est\xE3o faltando",w="Sensor n\xE3o encontrado",H="Dado n\xE3o encontrado",Ie={soilHumidity:{ideal:[20,60],intermediate:[[15,20],[60,65]]},temperature:{ideal:[18,30],intermediate:[[15,18],[30,33]]},condutivity:{ideal:[.2,2],intermediate:[[.15,.2],[2,2.5]]},ph:{ideal:[6,7],intermediate:[[5.5,6],[7,7.5]]},nitrogen:{ideal:[20,50],intermediate:[[15,20],[50,60]]},phosphorus:{ideal:[15,40],intermediate:[[10,15],[40,50]]},potassium:{ideal:[100,300],intermediate:[[80,100],[300,350]]}},I=(t,e,s=500)=>(console.error(e),t.status(s).json({message:e}));m.post("/sensors",async(t,e)=>{try{let{sensorName:s,location:n}=t.body,o=t.userId;return!o||!s||!n?e.status(400).json({message:S}):(await d.insert(a).values({userId:o,sensorName:s,location:n,installationDate:new Date}).execute(),e.status(201).json({message:"Sensor cadastrado com sucesso"}))}catch{return I(e,p)}});m.put("/user",async(t,e)=>{try{let s=t.userId,{name:n,email:o}=t.body;return!s||!n||!o?e.status(400).json({message:S}):(await d.update(y).set({name:n,email:o}).where((0,r.eq)(y.userId,s)).execute(),e.status(200).json({message:"Usu\xE1rio atualizado com sucesso"}))}catch{return I(e,p)}});m.delete("/user",async(t,e)=>{try{let s=t.userId;return s?(await d.delete(y).where((0,r.eq)(y.userId,s)).execute(),e.status(200).json({message:"Usu\xE1rio deletado com sucesso"})):e.status(400).json({message:"userId n\xE3o encontrado"})}catch{return I(e,p)}});m.patch("/sensors/:sensorId/assign",async(t,e)=>{try{let{sensorId:s}=t.params,n=t.userId;if(!n)return e.status(400).json({message:"userId n\xE3o encontrado"});if(isNaN(Number(s)))return e.status(400).json({message:"sensorId inv\xE1lido"});let[o]=await d.select().from(a).where((0,r.and)((0,r.eq)(a.sensorId,Number(s)),(0,r.isNull)(a.userId))).execute();return o?(await d.update(a).set({userId:n}).where((0,r.eq)(a.sensorId,Number(s))),e.status(200).json({message:"Sensor atribu\xEDdo ao usu\xE1rio com sucesso"})):e.status(404).json({message:"Sensor n\xE3o encontrado ou j\xE1 atribu\xEDdo a um usu\xE1rio"})}catch(s){return console.error(s),I(e,p)}});m.get("/sensors",async(t,e)=>{try{let s=t.userId,n=await d.select().from(a).where((0,r.eq)(a.userId,s)).execute();return n.length===0?e.status(404).json({message:pe}):e.status(200).json(n)}catch{return I(e,p)}});m.get("/sensors/:sensorId",async(t,e)=>{try{let s=Number(t.params.sensorId),n=t.userId,[o]=await d.select().from(a).where((0,r.and)((0,r.eq)(a.sensorId,s),(0,r.eq)(a.userId,n))).execute();return o?e.status(200).json(o):e.status(404).json({message:w})}catch{return I(e,p)}});m.put("/sensors/:sensorId",async(t,e)=>{try{let s=Number(t.params.sensorId),n=t.userId,{sensorName:o,location:i}=t.body;return!o||!i?e.status(400).json({message:"sensorName e location s\xE3o obrigat\xF3rios"}):(await d.update(a).set({sensorName:o,location:i}).where((0,r.and)((0,r.eq)(a.sensorId,s),(0,r.eq)(a.userId,n))).execute()).rowCount===0?e.status(404).json({message:w}):e.status(200).json({message:"Sensor atualizado com sucesso"})}catch(s){return console.error(s),I(e,p)}});m.delete("/sensors/:sensorId",async(t,e)=>{try{let s=Number(t.params.sensorId),n=t.userId;return(await d.delete(a).where((0,r.and)((0,r.eq)(a.sensorId,s),(0,r.eq)(a.userId,n))).execute()).rowCount===0?e.status(404).json({message:w}):e.status(200).json({message:"Sensor deletado com sucesso"})}catch{return I(e,p)}});m.post("/sensors/:sensorId/data",O,async(t,e)=>{try{let s=Number(t.params.sensorId),n=t.userId,{soilHumidity:o,temperature:i,condutivity:c,ph:g,nitrogen:f,phosphorus:R,potassium:b}=t.body;if(o==null||i==null||c==null||g==null||f==null||R==null||b==null)return e.status(400).json({message:S});let[N]=await d.select().from(a).where((0,r.and)((0,r.eq)(a.sensorId,s),(0,r.eq)(a.userId,n))).execute();if(!N)return e.status(404).json({message:w});await d.insert(h).values({sensorId:s,soilHumidity:o,temperature:i,condutivity:c,ph:g,nitrogen:f,phosphorus:R,potassium:b,dateTime:new Date}).execute();let _={soilHumidity:o,temperature:i,condutivity:c,ph:g,nitrogen:f,phosphorus:R,potassium:b},x=[];for(let D of Object.keys(_)){let v=_[D],{ideal:P,intermediate:C}=Ie[D],A;if(v>=P[0]&&v<=P[1])continue;C.some(([T,re])=>v>=T&&v<=re)?A="Alerta":A="Cr\xEDtico";let E=`${D} fora do intervalo ideal (${v})`;await d.insert(l).values({sensorId:s,message:E,level:A,timestamp:new Date}).execute(),x.push({metric:D,level:A,message:E})}return e.status(201).json({message:"Dados inseridos e alertas gerados",alerts:x})}catch{return I(e,p)}});m.get("/sensors/:sensorId/data",async(t,e)=>{try{let s=Number(t.params.sensorId),n=t.userId,[o]=await d.select().from(a).where((0,r.and)((0,r.eq)(a.sensorId,s),(0,r.eq)(a.userId,n))).execute();if(!o)return e.status(404).json({message:w});let i=await d.select().from(h).where((0,r.eq)(h.sensorId,s)).execute();return i.length===0?e.status(404).json({message:H}):e.status(200).json(i)}catch{return I(e,p)}});m.get("/sensors/:sensorId/data/:dataId",async(t,e)=>{try{let s=Number(t.params.sensorId),n=Number(t.params.dataId),o=t.userId,[i]=await d.select().from(a).where((0,r.and)((0,r.eq)(a.sensorId,s),(0,r.eq)(a.userId,o))).execute();if(!i)return e.status(404).json({message:w});let[c]=await d.select().from(h).where((0,r.and)((0,r.eq)(h.sensorDataId,n),(0,r.eq)(h.sensorId,s))).execute();return c?e.status(200).json(c):e.status(404).json({message:H})}catch{return I(e,p)}});m.put("/sensors/:sensorId/data/:dataId",async(t,e)=>{try{let s=Number(t.params.sensorId),n=Number(t.params.dataId),o=t.userId,{soilHumidity:i,temperature:c,condutivity:g,ph:f,nitrogen:R,phosphorus:b,potassium:N}=t.body,[_]=await d.select().from(a).where((0,r.and)((0,r.eq)(a.sensorId,s),(0,r.eq)(a.userId,o))).execute();return _?(await d.update(h).set({soilHumidity:i,temperature:c,condutivity:g,ph:f,nitrogen:R,phosphorus:b,potassium:N}).where((0,r.and)((0,r.eq)(h.sensorDataId,n),(0,r.eq)(h.sensorId,s))).execute()).rowCount===0?e.status(404).json({message:H}):e.status(200).json({message:"Dado do sensor atualizado com sucesso"}):e.status(404).json({message:w})}catch{return I(e,p)}});m.delete("/sensors/:sensorId/data/:dataId",async(t,e)=>{try{let s=Number(t.params.sensorId),n=Number(t.params.dataId),o=t.userId;return(await d.delete(h).where((0,r.and)((0,r.eq)(h.sensorDataId,n),(0,r.eq)(h.sensorId,s))).execute()).rowCount===0?e.status(404).json({message:H}):e.status(200).json({message:"Dado do sensor deletado com sucesso"})}catch{return I(e,p)}});m.post("/sensors/:sensorId/alert",async(t,e)=>{try{let s=Number(t.params.sensorId),n=t.userId,{message:o,level:i}=t.body;if(!o||!i)return e.status(400).json({message:S});if(isNaN(s))return e.status(400).json({message:"sensorId inv\xE1lido"});let[c]=await d.select().from(a).where((0,r.and)((0,r.eq)(a.sensorId,s),(0,r.eq)(a.userId,n))).execute();return c?(await d.insert(l).values({sensorId:s,message:o,level:i,timestamp:new Date}).execute(),e.status(201).json({message:"Alerta cadastrado com sucesso"})):e.status(404).json({message:w})}catch{return I(e,p)}});m.get("/sensor/:sensorId/alerts",async(t,e)=>{try{let{sensorId:s}=t.params,n=t.userId,o=Number(s);if(isNaN(o))return e.status(400).json({message:"sensorId invalido"});let[i]=await d.select().from(a).where((0,r.and)((0,r.eq)(a.sensorId,o),(0,r.eq)(a.userId,n))).execute();if(!i)return e.status(404).json({message:w});let c=await d.select().from(l).where((0,r.eq)(l.sensorId,o)).execute();return c.length===0?e.status(404).json({message:"Nenhum alerta encontrado para este sensor"}):e.status(200).json(c)}catch{return I(e,p)}});m.get("/sensors/:sensorId/alerts/:alertId",async(t,e)=>{try{let{sensorId:s,alertId:n}=t.params,o=t.userId,i=Number(s),c=Number(n);if(isNaN(i)||isNaN(c))return e.status(400).json({message:"sensorId ou alertId invalido"});let[g]=await d.select().from(a).where((0,r.and)((0,r.eq)(a.sensorId,i),(0,r.eq)(a.userId,o))).execute();if(!g)return e.status(404).json({message:w});let[f]=await d.select().from(l).where((0,r.and)((0,r.eq)(l.alertId,c),(0,r.eq)(l.sensorId,i))).execute();return f?e.status(200).json(f):e.status(404).json({message:"alerta nao encontrado para este sensor"})}catch{return I(e,p)}});m.put("/alert/:alertId",async(t,e)=>{try{let{alertId:s}=t.params,n=t.userId,{message:o,level:i}=t.body,c=Number(s);if(isNaN(c))return e.status(400).json({message:"alertId invalido"});if(!o||!i)return e.status(400).json({message:S});let[g]=await d.select().from(l).innerJoin(a,(0,r.eq)(l.sensorId,a.sensorId)).where((0,r.and)((0,r.eq)(l.alertId,c),(0,r.eq)(a.userId,n))).execute();return g?(await d.update(l).set({message:o,level:i}).where((0,r.eq)(l.alertId,c)).execute()).rowCount===0?e.status(404).json({message:"Falha ao atualizar o alerta"}):e.status(200).json({message:"Alerta atualizado com sucesso"}):e.status(404).json({message:"Alerta n\xE3o encontrado ou n\xE3o pertence ao usu\xE1rio"})}catch{return I(e,p)}});m.delete("/alert/:alertId",async(t,e)=>{try{let{alertId:s}=t.params,n=t.userId,o=Number(s);if(isNaN(o))return e.status(400).json({message:"alertId invalido"});let[i]=await d.select().from(l).innerJoin(a,(0,r.eq)(l.sensorId,a.sensorId)).where((0,r.and)((0,r.eq)(l.alertId,o),(0,r.eq)(a.userId,n))).execute();return i?(await d.delete(l).where((0,r.eq)(l.alertId,o)).execute()).rowCount===0?e.status(404).json({message:"Falha ao deletar o alerta"}):e.status(200).json({message:"Alerta deletado"}):e.status(404).json({message:"Alerta nao encontrado ou nao pertence ao usuario"})}catch{return I(e,p)}});var X=m;var M=j(require("bcrypt")),F=require("drizzle-orm"),Y=j(require("express")),z=j(require("jsonwebtoken"));var U=Y.default.Router(),Z=process.env.JWT_SECRET,L="Erro no Servidor, tente novamente",he="Usu\xE1rio n\xE3o encontrado",ge="Senha incorreta",fe="Email e senha s\xE3o obrigat\xF3rios",ye="Campos obrigat\xF3rios est\xE3o faltando",W=(t,e,s=500)=>(console.error(e),t.status(s).json({message:e}));U.post("/webhook/sensors/data",async(t,e)=>{try{let s=t.query.token;if(!s)return e.status(401).json({message:"Token ausente"});let[n]=await d.select().from(a).where((0,F.eq)(a.webhookToken,s)).execute();if(!n)return e.status(403).json({message:"Token inv\xE1lido"});let{soilHumidity:o,level_humidity:i,temperature:c,level_temperature:g,condutivity:f,level_condutivity:R,ph:b,level_ph:N,nitrogen:_,level_nitrogen:x,phosphorus:D,level_phosphorus:v,potassium:P,level_potassium:C}=t.body;await d.insert(h).values({sensorId:n.sensorId,soilHumidity:o,levelHumidity:i,temperature:c,levelTemperature:g,condutivity:f,levelCondutivity:R,ph:b,levelPh:N,nitrogen:_,levelNitrogen:x,phosphorus:D,levelPhosphorus:v,potassium:P,levelPotassium:C}).execute();let E=[{key:"Umidade do solo",level:i},{key:"Temperatura",level:g},{key:"Condutividade",level:R},{key:"pH",level:N},{key:"Nitrog\xEAnio",level:x},{key:"F\xF3sforo",level:v},{key:"Pot\xE1ssio",level:C}].filter(T=>T.level.toLowerCase()!=="ok").map(T=>({sensorId:n.sensorId,message:`${T.key} fora do intervalo ideal`,level:T.level,timestamp:new Date}));return E.length>0&&await d.insert(l).values(E).execute(),e.status(201).json({message:"Dados recebidos com sucesso",alerts:E})}catch{return W(e,L)}});U.post("/register",async(t,e)=>{try{let{name:s,email:n,password:o}=t.body;if(!s||!n||!o)return e.status(400).json({message:ye});let i=await M.default.genSalt(10),c=await M.default.hash(o,i),f=(await d.insert(y).values({name:s,email:n,password:c}).returning().execute())[0],R=z.default.sign({id:f.userId},Z,{expiresIn:"1h"});e.status(201).json({token:R,name:f.name,email:f.email})}catch{W(e,L)}});U.post("/login",async(t,e)=>{try{let{email:s,password:n}=t.body;if(!s||!n)return e.status(400).json({message:fe});let o=await d.select().from(y).where((0,F.eq)(y.email,s)).execute();if(o.length===0)return e.status(404).json({message:he});if(!await M.default.compare(n,o[0].password))return e.status(401).json({message:ge});let c=o[0],g=z.default.sign({id:c.userId},Z,{expiresIn:"1h"});e.status(200).json({token:g,name:c.name,email:c.email})}catch{W(e,L)}});var ee=U;var k=(0,J.default)();k.use((0,te.default)());k.use(J.default.json());k.use("/api",ee);k.use("/api",O,X);var se=process.env.PORT||3e3;k.listen(se,()=>{console.log(`\u2705 API rodando em http://localhost:${se}/api`)});
